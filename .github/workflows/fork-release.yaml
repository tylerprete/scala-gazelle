name: Fork Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag to release (e.g. v0.2.0)"
        required: true

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag_name || github.ref_name }}

      - name: Build source archive
        run: |
          TAG="${{ inputs.tag_name || github.ref_name }}"
          PREFIX="scala-gazelle-${TAG}"
          ARCHIVE="${PREFIX}.tar.gz"
          git archive --format=tar --prefix=${PREFIX}/ ${TAG} | gzip > ${ARCHIVE}
          SHA=$(shasum -a 256 ${ARCHIVE} | awk '{print $1}')
          echo "ARCHIVE=${ARCHIVE}" >> $GITHUB_ENV
          echo "SHA=${SHA}" >> $GITHUB_ENV
          echo "TAG=${TAG}" >> $GITHUB_ENV

          cat > release_notes.txt << EOF
          ## Usage

          In your \`MODULE.bazel\`, add an \`archive_override\` for the upstream module:

          \`\`\`starlark
          bazel_dep(name = "build_stack_scala_gazelle", version = "0.0.0")
          archive_override(
              module_name = "build_stack_scala_gazelle",
              urls = ["https://github.com/tylerprete/scala-gazelle/releases/download/${TAG}/${ARCHIVE}"],
              strip_prefix = "${PREFIX}",
              integrity = "sha256-$(echo -n ${SHA} | xxd -r -p | base64 | tr -d '\n')",
          )
          \`\`\`

          Or with \`http_archive\` in a WORKSPACE:

          \`\`\`starlark
          http_archive(
              name = "build_stack_scala_gazelle",
              sha256 = "${SHA}",
              strip_prefix = "${PREFIX}",
              urls = ["https://github.com/tylerprete/scala-gazelle/releases/download/${TAG}/${ARCHIVE}"],
          )
          \`\`\`
          EOF

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          body_path: release_notes.txt
          generate_release_notes: true
          files: ${{ env.ARCHIVE }}
